# Session — 2026-02-23 : Manager Agent v3

> Duree : ~5 heures
> Outil principal : Claude Code CLI (Opus 4.6) via Terminus

---

## Objectif

Remplacer le Manager Agent v2 (Classifier + Switch deterministe, 1 seul agent par requete) par un Manager v3 base sur le pattern LangChain Agent qui peut :
- Chainer plusieurs agents automatiquement (ex: prioritize → strategy)
- Synthetiser les resultats croises
- Repondre directement pour les salutations

## Ce qui a ete fait

### 1. Manager Agent v3 — Architecture LangChain

**Avant (v2)** : Classifier → Switch → 1 seul Execute Workflow (isole)
**Apres (v3)** : Agent LangChain (Claude Sonnet 4.5) → decide quels outils appeler et dans quel ordre

Architecture deployee (16+ nodes) :
```
Telegram Trigger → Extract & Detect → Is Voice?
  [voice] → Download → Whisper → Set Transcription ─┐
  [text] ────────────────────────────────────────────┘
                    ↓
         Agent Orchestrator (LangChain)
              ↕ Claude LM (Sonnet 4.5)
              ↕ Window Buffer Memory (40 msgs)
              ↕ 8 outils (toolWorkflow)
                    ↓
         Format Response (HTML tag balancing)
                    ↓
         Send Response (Telegram)
```

### 2. 8 outils connectes

| Outil | Sub-workflow | Description |
|-------|-------------|-------------|
| strategy | su5wJ4az3d9TsYV2 | Conseiller strategique, acces Notion |
| prioritize | pxThrV04KKdu1DEW | Scoring WICE des objectifs |
| decision | tO0K1z0G0aA2uNN8 | Decision Logger Notion |
| progress | T9b8PEm7mcZdIavF | Diagnostic progression |
| prospect | kMGVJvZyMhNaV9zU | Eclaireur commercial Avignon |
| search | lVIRJVTRokI7cEbi | Recherche web (SerpAPI + Wikipedia) |
| scrape | gNAlXq3Jx5RDRpvu | Scraper hybride (Jina + API custom) |
| knowledge | Z5SkxVoXLGQERTHO | Base de connaissances (sessions, competences) |

### 3. Nouveaux sub-workflows crees

**Hybrid Scraper** (`gNAlXq3Jx5RDRpvu`)
- Detecte mots-cles (reddit, spillbox, tiktok, stats, stock) → API custom 31.97.54.26:8000
- URL detectee → Jina AI Reader (r.jina.ai)
- Fallback intelligent

**Knowledge Base** (`Z5SkxVoXLGQERTHO`)
- Lit SESSION_INDEX.md et COMPETENCES.md depuis GitHub (raw)
- Fournit le contexte personnel de Chris a l'agent
- Chaine sequentielle pour eviter les race conditions

### 4. Documentation creee

- `docs/sessions/SESSION_INDEX.md` — index de 20+ sessions sur 3 repos
- `docs/COMPETENCES.md` — base de competences (7 domaines, niveaux, preuves)

### 5. Bugs resolus

| Bug | Cause | Fix |
|-----|-------|-----|
| Telegram "Unexpected end tag" | Tags HTML non equilibres dans la conversion markdown | Tag balancing : compte open/close pour b/i/u/s/code/pre, ajoute les manquants |
| "No session ID found" | Window Buffer Memory sans sessionKey | Ajout sessionIdType: "customKey" + sessionKey par chatId |
| Knowledge erreurs 50% | Fetch Sessions et Fetch Competences en parallele, Build Context executait avant les deux | Chaine sequentielle : Sessions → Competences → Build Context |

## Deploiement final

| Composant | ID | Status |
|-----------|-----|--------|
| Manager v3 | aGWUyr5oDb20I1zE | ACTIF |
| Scraper hybride | gNAlXq3Jx5RDRpvu | OK (5 success) |
| Knowledge Base | Z5SkxVoXLGQERTHO | OK (1 success) |
| Web Search | lVIRJVTRokI7cEbi | OK (5 success) |

Toutes les executions en success, zero erreur depuis le dernier deploiement.

## Script de deploiement

`n8n-workflows/create_workflows.py` — 3500+ lignes Python
- Gere la creation, activation, suppression de workflows via l'API n8n
- Contient tous les builders de nodes (agent, LM, toolWorkflow, code, if, etc.)
- Flags : `--couche3b-v3` (creation initiale), `--upgrade-v3` (upgrade avec scraper + knowledge)

## Reflexions

- Claude Code CLI a permis de construire un workflow n8n multi-agent complexe (16+ nodes, 8 outils, chaining, voice, memory) en une seule session
- Le pattern "script Python qui genere du JSON n8n via API" est puissant — pas besoin de l'UI pour des workflows complexes
- Points a ameliorer :
  - Postgres persistent memory (quand les credentials seront disponibles)
  - Affiner les descriptions des outils pour guider le chainage
  - Tester plus systematiquement chaque outil individuellement
  - Le custom API (31.97.54.26) a des endpoints casses (/pipeline/stats → "No module named 'routers'")

## IDs de reference

```
Manager v3 : aGWUyr5oDb20I1zE
Scraper :    gNAlXq3Jx5RDRpvu
Knowledge :  Z5SkxVoXLGQERTHO
Strategy :   su5wJ4az3d9TsYV2
Prioritizer: pxThrV04KKdu1DEW
Decision :   tO0K1z0G0aA2uNN8
Progress :   T9b8PEm7mcZdIavF
Scout v2 :   kMGVJvZyMhNaV9zU
Web Search : lVIRJVTRokI7cEbi
```
